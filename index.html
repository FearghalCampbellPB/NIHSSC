<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social Support Services Directory</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#6366f1', 
                        secondary: '#8b5cf6', 
                        accent: '#a855f7', 
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; }
        .gradient-bg { background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #a855f7 100%); }
        .card-shadow { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .input-focus:focus { border-color: #8b5cf6; box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.5); }
        .transition-all { transition-property: all; transition-duration: 300ms; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); }
        .group:hover .group-hover\:translate-x-1 { transform: translateX(0.25rem); }
        .group:hover .group-hover\:shadow-lg { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="min-h-screen flex flex-col">
        <header class="gradient-bg text-white py-6 shadow-lg">
            <div class="container mx-auto px-4 text-center">
                <h1 class="text-4xl md:text-5xl font-extrabold mb-2 leading-tight">Social Support Services Directory</h1>
                <p class="text-lg md:text-xl opacity-90 max-w-2xl mx-auto">Connecting individuals with vital social support organizations.</p>
            </div>
        </header>

        <main class="flex-grow container mx-auto px-4 py-8 md:py-12">
            
            <section class="bg-white p-6 rounded-xl card-shadow mb-8 sticky top-0 z-10">
                <h2 class="text-2xl font-bold mb-6 text-gray-900">Find Support Services</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label for="filter-name" class="block text-sm font-medium text-gray-700 mb-2">Organization Name</label>
                        <input type="text" id="filter-name" placeholder="e.g., Cancer Support"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-primary focus:border-primary input-focus transition-all">
                    </div>
                    <div>
                        <label for="filter-geography" class="block text-sm font-medium text-gray-700 mb-2">Geography Covered</label>
                        <select id="filter-geography" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-primary focus:border-primary input-focus transition-all bg-white">
                            <option value="">All Geographies</option>
                            <option disabled>Loading options...</option>
                        </select>
                    </div>
                    <div>
                        <label for="filter-support-type" class="block text-sm font-medium text-gray-700 mb-2">Type of Support</label>
                        <select id="filter-support-type" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-primary focus:border-primary input-focus transition-all bg-white">
                            <option value="">All Support Types</option>
                            <option disabled>Loading options...</option>
                        </select>
                    </div>
                </div>
                <div class="mt-8 flex flex-col sm:flex-row justify-end gap-4">
                    <button id="apply-filters" class="gradient-bg text-white px-8 py-3 rounded-lg font-semibold text-lg shadow-md hover:shadow-lg transform hover:-translate-y-0.5 transition-all w-full sm:w-auto">Apply Filters</button>
                    <button id="clear-filters" class="px-8 py-3 rounded-lg font-semibold text-lg bg-gray-200 text-gray-700 hover:bg-gray-300 shadow-md hover:shadow-lg transform hover:-translate-y-0.5 transition-all w-full sm:w-auto">Clear Filters</button>
                </div>
            </section>

            <div id="loading-indicator" class="text-center py-12">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary"></div>
                <p class="mt-4 text-gray-600">Loading directory data from Google Sheets...</p>
            </div>

            <section id="services-listing" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden">
                </section>

            <div id="no-results" class="hidden text-center py-12">
                <p class="text-xl text-gray-600">No services found matching your criteria.</p>
                <button onclick="clearAllFiltersAndRender()" class="mt-4 gradient-bg text-white px-6 py-2 rounded-lg font-semibold shadow-md hover:shadow-lg transition-all">
                    Clear Filters
                </button>
            </div>
        </main>

        <footer class="bg-gray-800 text-white py-6">
            <div class="container mx-auto px-4 text-center text-gray-400">
                <p>&copy; 2023 Social Support Directory. Powered by Google Sheets.</p>
            </div>
        </footer>
    </div>

    <script>
        // ==========================================
        // 1. CONFIGURATION
        // ==========================================
        // Paste your Google Sheet URL here (Edit link, Share link, or Publish link)
        // Ensure your sheet is shared as "Anyone with the link -> Viewer"
        const SHEET_URL = "PASTE_YOUR_GOOGLE_SHEET_URL_HERE"; 
        // ==========================================

        let allServices = [];

        // DOM Elements
        const servicesListing = document.getElementById('services-listing');
        const loadingIndicator = document.getElementById('loading-indicator');
        const filterNameInput = document.getElementById('filter-name');
        const filterGeographySelect = document.getElementById('filter-geography');
        const filterSupportTypeSelect = document.getElementById('filter-support-type');
        const applyFiltersBtn = document.getElementById('apply-filters');
        const clearFiltersBtn = document.getElementById('clear-filters');
        const noResultsMessage = document.getElementById('no-results');

        // Helper: Convert standard Google Sheet URL to the CORS-friendly Visualization API URL
        function getSafeApiUrl(url) {
            // Regex to extract the Spreadsheet ID (the long random string)
            const idMatch = url.match(/\/d\/([a-zA-Z0-9-_]+)/);
            if (!idMatch || !idMatch[1]) {
                console.error("Could not find Spreadsheet ID in URL");
                return url; // Return original if parsing fails
            }
            const id = idMatch[1];
            // Construct the Visualization API URL (defaults to first sheet)
            return `https://docs.google.com/spreadsheets/d/${id}/gviz/tq?tqx=out:csv`;
        }

        // --- STEP 1: INITIALIZE & FETCH DATA ---
        function init() {
            if(SHEET_URL === "PASTE_YOUR_GOOGLE_SHEET_URL_HERE") {
                alert("Please open the HTML file and paste your Google Sheet URL in the script tag.");
                return;
            }

            const safeUrl = getSafeApiUrl(SHEET_URL);
            console.log("Fetching data from:", safeUrl);

            Papa.parse(safeUrl, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    processData(results.data);
                },
                error: function(err) {
                    console.error("Error fetching data:", err);
                    loadingIndicator.innerHTML = `
                        <p class='text-red-500 font-bold'>Error loading data.</p>
                        <p class='text-sm text-gray-600'>1. Ensure Sheet is shared as 'Anyone with Link' -> 'Viewer'.</p>
                        <p class='text-sm text-gray-600'>2. Check your internet connection.</p>
                    `;
                }
            });
        }

        // --- STEP 2: PROCESS DATA ---
        function processData(data) {
            allServices = data.map((row, index) => {
                
                // Handle Support Types: Split by comma, trim whitespace
                let types = [];
                if (row.supportType) {
                    types = row.supportType.split(',').map(s => s.trim()).filter(s => s !== "");
                }

                // Handle Geography: Split by comma, trim whitespace
                let geos = [];
                if (row.geography) {
                    geos = row.geography.split(',').map(g => g.trim()).filter(g => g !== "");
                }
                
                return {
                    id: row.id || index,
                    name: row.name || "Unnamed Organization",
                    geography: geos, // Array of strings
                    supportType: types, // Array of strings
                    criteria: row.criteria || ""
                };
            });

            populateFilterOptions();
            renderServices(allServices);
            
            // UI Update: Hide loader, show results
            loadingIndicator.classList.add('hidden');
            servicesListing.classList.remove('hidden');
        }

        // --- STEP 3: POPULATE DROPDOWNS ---
        function populateFilterOptions() {
            const uniqueGeographies = new Set();
            const uniqueSupportTypes = new Set();

            allServices.forEach(service => {
                service.geography.forEach(geo => uniqueGeographies.add(geo));
                service.supportType.forEach(type => uniqueSupportTypes.add(type));
            });

            // Populate Geography Dropdown
            filterGeographySelect.innerHTML = '<option value="">All Geographies</option>';
            Array.from(uniqueGeographies).sort().forEach(geo => {
                const option = document.createElement('option');
                option.value = geo;
                option.textContent = geo;
                filterGeographySelect.appendChild(option);
            });

            // Populate Support Type Dropdown
            filterSupportTypeSelect.innerHTML = '<option value="">All Support Types</option>';
            Array.from(uniqueSupportTypes).sort().forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                filterSupportTypeSelect.appendChild(option);
            });
        }

        // --- STEP 4: RENDER CARDS ---
        function renderServices(filteredServices) {
            servicesListing.innerHTML = '';
            
            if (filteredServices.length === 0) {
                noResultsMessage.classList.remove('hidden');
                servicesListing.classList.add('hidden');
            } else {
                noResultsMessage.classList.add('hidden');
                servicesListing.classList.remove('hidden');
                
                // Limit display to 100 items to prevent browser lag on large datasets
                const displayLimit = filteredServices.length > 100 ? 100 : filteredServices.length;

                for(let i = 0; i < displayLimit; i++) {
                    const service = filteredServices[i];
                    
                    const card = document.createElement('div');
                    card.className = 'bg-white p-6 rounded-xl card-shadow border border-gray-200 group hover:group-hover:shadow-lg transition-all transform hover:-translate-y-1';
                    
                    // Create Support Type Badges
                    const badgesHtml = service.supportType.map(type => 
                        `<span class="px-3 py-1 bg-primary/10 text-primary text-xs font-medium rounded-full">${type}</span>`
                    ).join('');

                    // Join Geography array back to string for display
                    const geoDisplay = service.geography.join(', ');

                    card.innerHTML = `
                        <h3 class="font-bold text-xl text-gray-900 mb-3">${service.name}</h3>
                        <p class="text-sm text-gray-600 mb-2"><strong>Geography:</strong> ${geoDisplay}</p>
                        <div class="flex flex-wrap gap-2 mb-4">${badgesHtml}</div>
                        <p class="text-gray-700 text-sm"><strong>Criteria:</strong> ${service.criteria}</p>
                    `;
                    servicesListing.appendChild(card);
                }
            }
        }

        // --- STEP 5: FILTER LOGIC ---
        function applyFilters() {
            const nameFilter = filterNameInput.value.toLowerCase().trim();
            const geographyFilter = filterGeographySelect.value;
            const supportTypeFilter = filterSupportTypeSelect.value;

            const filtered = allServices.filter(service => {
                // Name match
                const matchesName = nameFilter === "" || (service.name && service.name.toLowerCase().includes(nameFilter));
                
                // Geography match: Check if service.geography array INCLUDES the selected value
                const matchesGeography = geographyFilter === "" || service.geography.includes(geographyFilter);
                
                // Type match: Check if service.supportType array INCLUDES the selected value
                const matchesSupportType = supportTypeFilter === "" || service.supportType.includes(supportTypeFilter);
                
                return matchesName && matchesGeography && matchesSupportType;
            });

            renderServices(filtered);
        }

        function clearFilters() {
            filterNameInput.value = '';
            filterGeographySelect.value = '';
            filterSupportTypeSelect.value = '';
            applyFilters();
        }

        function clearAllFiltersAndRender() {
            clearFilters();
        }

        // --- EVENTS ---
        document.addEventListener('DOMContentLoaded', init);
        
        applyFiltersBtn.addEventListener('click', applyFilters);
        clearFiltersBtn.addEventListener('click', clearFilters);
        filterNameInput.addEventListener('input', applyFilters); 
        filterGeographySelect.addEventListener('change', applyFilters);
        filterSupportTypeSelect.addEventListener('change', applyFilters);
    </script>
</body>
</html>
